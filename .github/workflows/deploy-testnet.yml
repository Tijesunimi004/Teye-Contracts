name: Deploy to Testnet

on:
  push:
    branches: [ develop ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      contract:
        description: 'Contract to deploy (leave empty for all)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        type: boolean
        default: false

env:
  RUST_VERSION: "1.92.0"
  SOROBAN_VERSION: "23.1.4"
  NETWORK: "testnet"

jobs:
  # Run tests before deployment
  pre-deploy-tests:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install Soroban CLI
        run: |
          cargo install --locked --version ${{ env.SOROBAN_VERSION }} soroban-cli

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run all tests
        run: cargo test --all

  # Build contracts
  build:
    name: Build Contracts
    runs-on: ubuntu-latest
    needs: [pre-deploy-tests]
    if: always() && (needs.pre-deploy-tests.result == 'success' || needs.pre-deploy-tests.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install Soroban CLI
        run: |
          cargo install --locked --version ${{ env.SOROBAN_VERSION }} soroban-cli

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build optimized contracts
        run: |
          mkdir -p dist
          for contract in contracts/*/; do
            if [ -d "$contract" ]; then
              contract_name=$(basename "$contract")
              echo "Building contract: $contract_name"
              cd "$contract"
              cargo build --target wasm32-unknown-unknown --release
              cd - > /dev/null
              
              wasm_file="$contract/target/wasm32-unknown-unknown/release/${contract_name}.wasm"
              if [ -f "$wasm_file" ]; then
                cp "$wasm_file" "dist/${contract_name}.wasm"
                echo "Copied: ${contract_name}.wasm"
              fi
            fi
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-contracts
          path: dist/*.wasm
          retention-days: 7

  # Deploy to testnet
  deploy:
    name: Deploy to Testnet
    runs-on: ubuntu-latest
    needs: [build]
    environment:
      name: testnet
      url: https://soroban-testnet.stellar.org
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install Soroban CLI
        run: |
          cargo install --locked --version ${{ env.SOROBAN_VERSION }} soroban-cli

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-contracts
          path: dist/

      - name: Configure Soroban network
        run: |
          soroban config network add testnet \
            --rpc-url https://soroban-testnet.stellar.org:443 \
            --network-passphrase "Test SDF Network ; September 2015" || true

      - name: Setup deployment identity
        env:
          SOROBAN_SECRET_KEY: ${{ secrets.TESTNET_DEPLOYER_SECRET_KEY }}
        run: |
          # Add identity from secret key if provided
          if [ -n "$SOROBAN_SECRET_KEY" ]; then
            echo "$SOROBAN_SECRET_KEY" > /tmp/secret_key.txt
            soroban config identity add deployer-testnet --secret-key /tmp/secret_key.txt || true
            rm -f /tmp/secret_key.txt
          else
            # Generate new identity if no secret key provided
            if ! soroban config identity show deployer-testnet &> /dev/null; then
              soroban config identity generate deployer-testnet
            fi
            # Fund the account
            soroban config identity fund deployer-testnet --network testnet || true
          fi

      - name: Deploy contracts
        id: deploy
        run: |
          mkdir -p deployments
          deployment_log="deployments/testnet_$(date +%Y%m%d_%H%M%S).json"
          echo "[]" > "$deployment_log"
          
          # Determine which contracts to deploy
          if [ -n "${{ inputs.contract }}" ]; then
            contracts="${{ inputs.contract }}"
          else
            contracts=$(ls -d contracts/*/ | xargs -n1 basename)
          fi
          
          for contract_name in $contracts; do
            wasm_file="dist/${contract_name}.wasm"
            if [ ! -f "$wasm_file" ]; then
              echo "Warning: $wasm_file not found, skipping"
              continue
            fi
            
            echo "Deploying $contract_name to testnet..."
            
            # Deploy contract
            contract_id=$(soroban contract deploy \
              --wasm "$wasm_file" \
              --source deployer-testnet \
              --network testnet \
              --output json | jq -r '.contract_id' || echo "")
            
            if [ -z "$contract_id" ] || [ "$contract_id" = "null" ]; then
              echo "Error: Failed to deploy $contract_name"
              exit 1
            fi
            
            echo "Deployed $contract_name: $contract_id"
            
            # Save deployment info
            jq --arg name "$contract_name" \
               --arg id "$contract_id" \
               --arg network "testnet" \
               --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
               --arg commit "${{ github.sha }}" \
               '. += [{
                 "contract_name": $name,
                 "contract_id": $id,
                 "network": $network,
                 "deployed_at": $timestamp,
                 "commit_sha": $commit,
                 "deployer": "deployer-testnet"
               }]' "$deployment_log" > "${deployment_log}.tmp" && mv "${deployment_log}.tmp" "$deployment_log"
          done
          
          echo "deployment_log=$deployment_log" >> $GITHUB_OUTPUT
          cat "$deployment_log"

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployments/*.json
          retention-days: 90

      - name: Create deployment summary
        run: |
          echo "## Testnet Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Contracts" >> $GITHUB_STEP_SUMMARY
          cat "${{ steps.deploy.outputs.deployment_log }}" | jq -r '.[] | "- **\(.contract_name)**: `\(.contract_id)`"' >> $GITHUB_STEP_SUMMARY

  # Post-deployment verification
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Soroban CLI
        run: |
          cargo install --locked --version ${{ env.SOROBAN_VERSION }} soroban-cli

      - name: Download deployment info
        uses: actions/download-artifact@v4
        with:
          name: deployment-info
          path: deployments/

      - name: Verify contracts
        run: |
          for deployment_file in deployments/*.json; do
            if [ -f "$deployment_file" ]; then
              echo "Verifying deployments from $deployment_file"
              cat "$deployment_file" | jq -r '.[] | "\(.contract_name): \(.contract_id)"' | while read line; do
                contract_id=$(echo "$line" | cut -d: -f2 | xargs)
                echo "Verifying contract: $contract_id"
                soroban contract invoke \
                  --id "$contract_id" \
                  --network testnet \
                  -- --help || echo "Warning: Could not verify $contract_id"
              done
            fi
          done

